{% extends "../base.html" %}
{% load markdown %}
{% load i18n %}
{% load static %}
{% load compress %}
{% load cache %}

{% block extra_head %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/bootstrap-input-spinner@1.12.7/src/bootstrap-input-spinner.js"></script>
    {% compress js %}
    <script src="{% static 'js/bootstrap-show-modal.js' %}"></script>
    {%  endcompress %}
{%  endblock %}
{% block body %}
    <div id="songs">
        <div class="control">
            <div class="input-group mb-3 mx-1 w-100 pr-3 mb-2" style="max-width: 500px;">
                <div class="input-group-prepend">
                    <span class="input-group-text">{% trans "Search" %}</span>
                </div>
                <input class="search form-control" />
            </div>
            <div class="input-group d-inline mb-2">
                <span class="ml-1 input-group-prepend d-flex justify-content-sm-start justify-content-center mr-1">
                    <button class="btn btn-outline-secondary sort" data-sort="index" type="button">{% trans "Index" %}</button>
                    <button class="btn btn-outline-secondary sort" data-sort="name" type="button">{% trans "Name" %}</button>
                    <button class="btn btn-outline-secondary sort" data-sort="author" type="button" style="border-top-right-radius: 0.25rem;border-bottom-right-radius: 0.25rem;">{% trans "Author" %}</button>
                </span>
            </div>
        </div>

        <ul class="song-list list mt-2 ml-1">
        {% for song in songs %}
            <li>
             <span class="d-none index">{{ song.song_number }}</span>
             <span class="d-none text">{{ song.text }}</span>
             <span class="d-none name">{{ song.name }}</span>
             <span class="d-none author">{{ song.author }}</span>
             <div class="collapsible-controller w-100 mb-2" onclick="collapsible(this,'{{ song.song_number }}')">
                 <h2 class="d-inline"><span style="width: 50px;">{{ song.song_number }}.</span> {{ song.name }}</h2>
                {%  if song.author %}
                    <h6 class="d-inline" >{{ song.author }}</h6>
                {%  endif %}
                {% if user.is_authenticated %}
                   <form class="d-inline ml-3" action="{% url 'chords:edit' pk=song.id %}" method="get">
                       <input class="btn btn-secondary" type="submit" value="{%  trans "Edit" %}"/>
                   </form>
                   <button class="btn btn-danger ml-2" onclick="confirmDelete(event, '{{ song.name }}', '{% url 'chords:delete' pk=song.id %}')">
                        {% trans "Delete" %}
                   </button>
                {%  endif %}
             </div>
             <div id="{{ song.song_number }}" style="display: none;">
                <div class="input-group mb-3">
                    {% if song.link %}
                        <a href="{{ song.link }}" class="btn btn-primary" role="button" aria-pressed="true">
                            <i class="icon-youtube-play"></i> {#{% trans "Youtube link" %}#}
                        </a>
                    {% endif %}
                    <div class="input-group-prepend">
                      <span class="input-group-text">{% trans "Transpose" %}</span>
                    </div>
                    <input class="form-control-sm" type="number" value="0" min="-11" max="11" step="1" previous_value=0 onchange="transpose(event, this, {{ song.song_number }} )"/>
                </div>
                <div class="text-wrap song-text">
                {{ song.text|show_markdown|safe }}
                </div>
             </div>
            </li>
        {% endfor %}
        </ul>
    </div>
    <a id="back-to-top" href="#" class="btn btn-primary btn-lg back-to-top" role="button" title="Click to return on the top page" data-toggle="tooltip" data-placement="left">
        <span class="icon-up-open"></span>
    </a>
    {% compress js %}
    <script>
    function confirmDelete(event, songName, url) {
        $.showConfirm({
            title: "{% trans "Please confirm" %}", body: "{% blocktrans %}Are you sure you wanna delete song{% endblocktrans %} " + songName + "?", textTrue: "Yes", textFalse: "No",
            onSubmit: function (result) {
                if (result) {
                    window.location.replace(url);
                }
            }
        });
        event.stopPropagation();
        event.preventDefault();
    }
    $(document).ready(function(){
         $(window).scroll(function () {
                if ($(this).scrollTop() > 50) {
                    $('#back-to-top').fadeIn();
                } else {
                    $('#back-to-top').fadeOut();
                }
            });
            // scroll body to 0px on click
            $('#back-to-top').click(function () {
                $('#back-to-top').tooltip('hide');
                $('body,html').animate({
                    scrollTop: 0
                }, 800);
                return false;
            });

            $('#back-to-top').tooltip('show');

    });
    function collapsible(element, id) {
        const collapsible = $('#' + id);

        if (collapsible.hasClass('unrolled') === true) {
            collapsible.slideUp();
        } else {
            collapsible.slideDown();
        }
        collapsible.toggleClass("unrolled");
        element.classList.toggle("unrolled");
    }

    const regex = /[CDEFGAH](b|#)?/g;

    $("input[type='number']").inputSpinner({
        decrementButton: "<i class=\"icon-minus\"></i>", // button text
        incrementButton: "<i class=\"icon-plus\"></i>",
        groupClass: "transposer",
    });

    function transposeChord(chord, amount) {
        //const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        //const normalizeMap = {"Cb":"B", "Db":"C#", "Eb":"D#", "Fb":"E", "Gb":"F#", "Ab":"G#", "Bb":"A#",  "E#":"F", "B#":"C"};
        const scale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "H"];
        const normalizeMap = {"Cb":"H", "Db":"C#", "Eb":"D#", "Fb":"E", "Gb":"F#", "Ab":"G#", "Hb":"A#",  "E#":"F", "H#":"C"};
        return chord.replace(regex, function(match) {
            let i = (scale.indexOf((normalizeMap[match] ? normalizeMap[match] : match)) + amount) % scale.length;
            return scale[ i < 0 ? i + scale.length : i ];
        })
    }

    function transpose(event, object, id) {
        const input = $(object);
        const old_value = input.attr("previous_value");
        const new_value = input.val();
        const diff = new_value - old_value;
        $("#" + id).find(".chord").each(function(element) {
            $( this ).html(transposeChord($( this ).html(), diff))
        });
        input.attr("previous_value", new_value);
    }

    const songList = new List('songs', {
        valueNames: [ 'name', 'author', 'text', 'index' ],
        alphabet: "AÁBCČDĎEÉĚFGHChIÍJKLMNŇOÓPQRŘSŠTŤUÚŮVWXYÝZŽaábcčdďeéěfghchiíjklmnňoópqrřsštťuúůvwxyýzž"
    });
    </script>
    {% endcompress js %}
{% endblock %}